{% extends "base.html" %}

{% block content %}
<!-- Link to Custom CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

<!-- Sidebar -->
<div class="wrapper">
    <!-- Sidebar -->
<nav id="sidebar" class="active">
    <div class="sidebar-header">
        <h3>Admin Dashboard</h3>
    </div>

    <ul class="list-unstyled components">
        <li>
            <a href="#users" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Users</a>
            <ul class="collapse list-unstyled" id="users">
                <li><a href="#all-users">All Users</a></li>
                <li><a href="#online-users">Online Users</a></li>
            </ul>
        </li>
        <li>
            <a href="#groups" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Groups</a>
            <ul class="collapse list-unstyled" id="groups">
                <li><a href="#all-groups">All Groups</a></li>
            </ul>
        </li>
        <li>
            <a href="#messages" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Messages</a>
            <ul class="collapse list-unstyled" id="messages">
                <li><a href="#all-messages">All Messages</a></li>
            </ul>
        </li>
    </ul>
</nav>

<!-- Toggle Button for Sidebar -->
<button type="button" id="sidebarCollapse" class="btn btn-info">
    <i class="fas fa-align-left"></i>
</button>

<!-- Page Content -->
<div id="content">
    <!-- Main Content -->
    <div class="container-fluid">
        <h1 class="mt-4">Admin Dashboard</h1>

        <!-- Cards for Statistics -->
        <div class="row">
            <div class="col-md-4">
                <div class="card bg-primary text-white mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Total Users</h5>
                        <p class="card-text">{{ users|length }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Online Users</h5>
                        <p class="card-text">{{ online_users_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-white mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Total Messages</h5>
                        <p class="card-text">{{ messages|length }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <h2>Users</h2>
        <table class="table table-hover table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Online</th>
                    <th>Last Seen</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.custom_id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ "Online" if user.is_online else "Offline" }}</td>
                    <td>{{ user.last_seen.strftime('%Y-%m-%d %H:%M:%S') if user.last_seen else "Never" }}</td>
                    <td>
                        <a href="{{ url_for('message.admin_view_user', user_id=user.custom_id) }}" class="btn btn-info btn-sm"><i class="fas fa-eye"></i></a>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('{{ user.custom_id }}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Groups Table -->
        <h2>Groups</h2>
        <table class="table table-hover table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Group Name</th>
                    <th>Created By</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for group in groups %}
                <tr>
                    <td>{{ group.custom_id }}</td>
                    <td>{{ group.group_name }}</td>
                    <td>{{ group.created_by }}</td>
                    <td>{{ group.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteGroup('{{ group.custom_id }}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Messages Table -->
        <h2>Messages</h2>
        <table class="table table-hover table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Sender</th>
                    <th>Receiver</th>
                    <th>Message</th>
                    <th>Timestamp</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for message in messages %}
                <tr>
                    <td>{{ message.custom_id }}</td>
                    <td>{{ message.sender_id }}</td>
                    <td>{{ message.receiver_id }}</td>
                    <td>{{ message.message_text }}</td>
                    <td>{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteMessage('{{ message.custom_id }}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- JavaScript for Sidebar Toggle and Delete Actions -->
<script>
   

    // Delete Group
    function deleteGroup(groupId) {
        if (confirm("Are you sure you want to delete this group?")) {
            fetch(`/admin/delete_group/${groupId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Group deleted successfully!");
                        window.location.reload();
                    } else {
                        alert("Error deleting group: " + data.error);
                    }
                });
        }
    }

    // Delete Message
    function deleteMessage(messageId) {
        if (confirm("Are you sure you want to delete this message?")) {
            fetch(`/admin/delete_message/${messageId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Message deleted successfully!");
                        window.location.reload();
                    } else {
                        alert("Error deleting message: " + data.error);
                    }
                });
        }
    }
</script>
<!-- JavaScript for Sidebar Toggle and Dropdown Handling -->
<script>
    // Sidebar Toggle
    document.getElementById('sidebarCollapse').addEventListener('click', function () {
        document.getElementById('sidebar').classList.toggle('active');
    });

    // Dropdown Handling for Small Screens
    const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
    dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function (e) {
            if (window.innerWidth <= 768) {
                e.preventDefault();
                const target = this.getAttribute('href');
                const dropdown = document.querySelector(target);
                dropdown.classList.toggle('show');
            }
        });
    });
</script>
<!-- FontAwesome Icons -->
<script src="https://kit.fontawesome.com/a076d05399.js"></script>
{% endblock %}