<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TomChat</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Consolidated Styles */
      body { background-color: #f4f7fc; font-family: Arial, sans-serif; }
      .container { margin-top: 20px; }
      .card { margin-bottom: 20px; border-radius: 10px; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); }
      table { background-color: #fff; border-radius: 8px; overflow: hidden; }
      th, td { text-align: center; padding: 12px; }
      thead.thead-dark th { background-color: #343a40; color: white; }
      .pagination { margin-top: 20px; }
      .page-item.active .page-link { background-color: #6c63ff; border-color: #6c63ff; }
      .page-link { color: #6c63ff; }
      .page-link:hover { color: #6c63ff; background-color: #f0f2f5; }
      .sidebar { width: 200px; height: 100vh; position: fixed; background: #343a40; padding-top: 20px; color: white; }
      #main-content { margin-left: 220px; padding: 20px; }
      .btn { margin: 5px; }
      .modal-img { width: 100px; height: 100px; object-fit: cover; }
      .chart-container { height: 400px; margin: 20px 0; }
  </style>
</head>
<body>

    <!-- Main Content -->
    <div class="container mt-4">
        <h1 class="text-center text-primary mb-4">Admin Dashboard</h1>
        
        <div class="chart-container">
          <canvas id="dashboardChart"></canvas>
        </div>
        <!-- Statistics Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5>Total Users</h5>
                        <p id="total-users" class="display-4">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5>Online Users</h5>
                        <p id="online-users-count" class="display-4">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5>Total Messages</h5>
                        <p id="total-messages" class="display-4">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5>Total Groups</h5>
                        <p id="total-groups" class="display-4">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Actions -->
        <div class="row mt-4">
            <div class="col-md-4">
                <input type="text" id="searchUsers" class="form-control" placeholder="Search users...">
            </div>
            <div class="col-md-8">
                <button class="btn btn-success" id="exportUsers"><i class="fas fa-file-export"></i> Export Users</button>
                <button class="btn btn-danger" id="bulkActions"><i class="fas fa-tasks"></i> Bulk Actions</button>
            </div>
        </div>

        <!-- Data Tables -->
        <!-- Users Table -->
        <div class="mt-4">
            <h2>Users</h2>
            <table class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Last Seen</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
            <nav aria-label="Users pagination"><ul class="pagination" id="users-pagination"></ul></nav>
        </div>

        <!-- Groups Table -->
        <div class="mt-4">
            <h2>Groups</h2>
            <table class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Group Name</th>
                        <th>Created By</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="groups-table-body"></tbody>
            </table>
            <nav aria-label="Groups pagination"><ul class="pagination" id="groups-pagination"></ul></nav>
        </div>

        <!-- Messages Table -->
        <div class="mt-4">
            <h2>Messages</h2>
            <table class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Sender</th>
                        <th>Receiver</th>
                        <th>Message</th>
                        <th>Timestamp</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="messages-table-body"></tbody>
            </table>
            <nav aria-label="Messages pagination"><ul class="pagination" id="messages-pagination"></ul></nav>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Details</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body text-center">
                    <img id="user-profile-pic" src="" alt="Profile Picture" class="modal-img rounded-circle mb-3">
                    <div class="user-details">
                        <p><strong>Username:</strong> <span id="user-username"></span></p>
                        <p><strong>Status:</strong> <span id="user-status"></span></p>
                        <p><strong>Online:</strong> <span id="user-online"></span></p>
                        <p><strong>Blocked:</strong> <span id="user-blocked"></span></p>
                        <p><strong>Last Seen:</strong> <span id="user-last-seen"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // Socket.IO and Chart Initialization
        const socket = io('/admin');
        let chart;

        // Initialization
        document.addEventListener("DOMContentLoaded", () => {
            initializeChart();
            loadAllData();
            setupEventListeners();
        });

        // Fixed Chart Initialization
        function initializeChart() {
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Users', 'Online', 'Messages', 'Groups'],
                    datasets: [{
                        label: 'Statistics',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Updated Real-time Updates Handler
        function updateDashboard(data) {
            // Update statistics numbers
            document.getElementById('total-users').textContent = data.total_users;
            document.getElementById('online-users-count').textContent = data.online_users_count;
            document.getElementById('total-messages').textContent = data.total_messages;
            document.getElementById('total-groups').textContent = data.total_groups;

            // Update chart data
            if (chart) {
                chart.data.datasets[0].data = [
                    data.total_users,
                    data.online_users_count,
                    data.total_messages,
                    data.total_groups
                ];
                chart.update('none'); // Prevent animation loop
            }
        }
        // Event Listeners
        function setupEventListeners() {
            document.getElementById('searchUsers').addEventListener('input', searchUsers);
            document.getElementById('exportUsers').addEventListener('click', exportUsers);
            socket.on('update_dashboard', updateDashboard);
        }

        // Data Loading
        async function loadAllData() {
            await Promise.all([loadUsers(), loadGroups(), loadMessages()]);
        }

        async function loadData(endpoint, tableId, paginationId, template) {
            try {
                const res = await fetch(endpoint);
                const data = await res.json();
                
                // Update table
                document.getElementById(tableId).innerHTML = data[tableId.replace('-table-body', '')]
                    .map(item => template(item))
                    .join('');

                // Update pagination
                document.getElementById(paginationId).innerHTML = Array.from(
                    {length: data.total_pages}, 
                    (_, i) => `<li class="page-item ${i+1 === data.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="load${paginationId.split('-')[0]}(${i+1})">${i+1}</a>
                    </li>`
                ).join('');

            } catch (error) {
                console.error('Loading error:', error);
                alert('Error loading data');
            }
        }

        // Users
        function loadUsers(page=1) {
            return loadData(`/admin/get_users?page=${page}`, 'users-table-body', 'users-pagination', user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.is_online ? "Online" : "Offline"}</td>
                    <td>${user.last_seen || 'Never'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')"><i class="fas fa-trash"></i></button>
                        <button class="btn btn-warning btn-sm" onclick="toggleBlock('${user.id}')"><i class="fas fa-ban"></i></button>
                        <button class="btn btn-info btn-sm" onclick="viewUser('${user.id}')"><i class="fas fa-eye"></i></button>
                    </td>
                </tr>`);
        }

        // Groups
        function loadGroups(page=1) {
            return loadData(`/admin/get_groups?page=${page}`, 'groups-table-body', 'groups-pagination', group => `
                <tr>
                    <td>${group.id}</td>
                    <td>${group.group_name}</td>
                    <td>${group.created_by}</td>
                    <td>${new Date(group.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteGroup('${group.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`);
        }

        // Messages
        function loadMessages(page=1) {
            return loadData(`/admin/get_messages?page=${page}`, 'messages-table-body', 'messages-pagination', message => `
                <tr>
                    <td>${message.id}</td>
                    <td>${message.sender_id}</td>
                    <td>${message.receiver_id}</td>
                    <td>${message.message_text}</td>
                    <td>${new Date(message.timestamp).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteMessage('${message.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`);
        }

        // Actions
        async function deleteItem(endpoint, reloadFunc) {
            if (confirm("Are you sure?")) {
                try {
                    const res = await fetch(endpoint, { method: 'DELETE' });
                    const data = await res.json();
                    if (data.success) reloadFunc();
                    alert(data.message || "Operation completed");
                } catch (error) {
                    console.error('Delete error:', error);
                    alert("Operation failed");
                }
            }
        }

        const deleteUser = id => deleteItem(`/admin/delete_user/${id}`, loadUsers);
        const deleteGroup = id => deleteItem(`/admin/delete_group/${id}`, loadGroups);
        const deleteMessage = id => deleteItem(`/admin/delete_message/${id}`, loadMessages);

        // Search
        async function searchUsers() {
            const query = document.getElementById('searchUsers').value;
            try {
                const res = await fetch(`/admin/search_users?query=${encodeURIComponent(query)}`);
                const data = await res.json();
                document.getElementById('users-table-body').innerHTML = data.users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.is_online ? "Online" : "Offline"}</td>
                        <td>${user.last_seen}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')"><i class="fas fa-trash"></i></button>
                            <button class="btn btn-warning btn-sm" onclick="toggleBlock('${user.id}')"><i class="fas fa-ban"></i></button>
                            <button class="btn btn-info btn-sm" onclick="viewUser('${user.id}')"><i class="fas fa-eye"></i></button>
                        </td>
                    </tr>`).join('');
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        // View User Details
        async function viewUser(userId) {
            try {
                const res = await fetch(`/admin/view_user/${userId}`);
                const data = await res.json();
                
                document.getElementById("user-profile-pic").src = data.profile_picture || "default.jpg";
                document.getElementById("user-username").textContent = data.username;
                document.getElementById("user-status").textContent = data.status;
                document.getElementById("user-online").textContent = data.is_online ? "Yes" : "No";
                document.getElementById("user-blocked").textContent = data.is_blocked ? "Yes" : "No";
                document.getElementById("user-last-seen").textContent = data.last_seen || "Never";
                
                $('#userDetailsModal').modal('show');
            } catch (error) {
                console.error('View user error:', error);
            }
        }

        // Real-time Updates
        function updateDashboard(data) {
            document.getElementById('total-users').textContent = data.total_users;
            document.getElementById('online-users-count').textContent = data.online_users_count;
            document.getElementById('total-messages').textContent = data.total_messages;
            document.getElementById('total-groups').textContent = data.total_groups;
            
            if (chart) {
                chart.data.datasets[0].data = [
                    data.total_users,
                    data.online_users_count,
                    data.total_messages,
                    data.total_groups
                ];
                chart.update();
            }
        }

        // // Chart Initialization
        // function initializeChart() {
        //     const ctx = document.createElement('canvas');
        //     ctx.id = 'dashboardChart';
        //     document.querySelector('.container').prepend(ctx);
            
        //     chart = new Chart(ctx, {
        //         type: 'bar',
        //         data: {
        //             labels: ['Users', 'Online', 'Messages', 'Groups'],
        //             datasets: [{
        //                 label: 'Statistics',
        //                 data: [0, 0, 0, 0],
        //                 backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
        //             }]
        //         },
        //         options: {
        //             responsive: true,
        //             maintainAspectRatio: false
        //         }
        //     });
        // }
    </script>
</body>
</html>